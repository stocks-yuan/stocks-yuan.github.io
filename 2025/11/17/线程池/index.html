<!DOCTYPE html>
<html lang="zh-CN">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="çº¿ç¨‹æ± å®ç°" />
    <meta name="hexo-theme-A4" content="v2.0.0" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.jpg">
    <title>Stocks</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery-bundle.min.css">


   
        
<link rel="stylesheet" href="/css/custom.css">

    
    <link rel='stylesheet' href='https://chinese-fonts-cdn.deno.dev/packages/lxgwwenkai/dist/LXGWWenKai-Regular/result.css' /> 
<meta name="generator" content="Hexo 8.1.1">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
    
    

    
    



    
        <style>
            .paper-main{
                max-width:  1200px;
            }
        </style>

    
    




    
    
    <style>
        body {
            background-image: url(/img/bg3.png);
            background-attachment: fixed;  /* èƒŒæ™¯å›ºå®šï¼Œä¸éšé¡µé¢æ»šåŠ¨ */
            background-repeat: no-repeat;  /* é˜²æ­¢èƒŒæ™¯å›¾ç‰‡é‡å¤ */
            background-size: cover;       /* èƒŒæ™¯è‡ªé€‚åº”å¤§å°ï¼Œè¦†ç›–æ•´ä¸ªèƒŒæ™¯ */
            background-position: center;   /* èƒŒæ™¯å±…ä¸­æ˜¾ç¤º */
        }
        .paper {
            background-image: url(/img/bg3.png);
            background-attachment: fixed;  /* èƒŒæ™¯å›ºå®šï¼Œä¸éšé¡µé¢æ»šåŠ¨ */
            background-repeat: no-repeat;  /* é˜²æ­¢èƒŒæ™¯å›¾ç‰‡é‡å¤ */
            background-size: cover;       /* èƒŒæ™¯è‡ªé€‚åº”å¤§å°ï¼Œè¦†ç›–æ•´ä¸ªèƒŒæ™¯ */
            background-position: center;   /* èƒŒæ™¯å±…ä¸­æ˜¾ç¤º */
        }  
    </style>



    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        
            
                <div class="left-toc-container">
                    <nav id="toc" class="bs-docs-sidebar"></nav>
                </div>
            
        
        <div class="paper">

            

            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <style>
            .header-img {
                width: 56px;
                height: auto;
                object-fit: cover; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ */
                transition: transform 0.3s ease-in-out; 
                border-radius: 50%; 
            }
            
        </style>
        <img 
            alt="^-^" 
            cache-control="max-age=86400" 
            class="header-img" 
            src="/img/favicon.jpg" 
        />
        <div class="header-content">
            <a class="logo" href="/">Stocks</a> 
            <span class="description">åµŒå…¥å¼ç³»ç»Ÿå¼€å‘ | æœºå™¨äººç®—æ³•</span> 
        </div>
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">ğŸ  é¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">ğŸ“æ–‡ç« </a></li>
            
        
            
                <li><a href="/tags/">ğŸ“Œæ ‡ç­¾</a></li>
            
        
            
                <li><a href="/categories/">ğŸ“åˆ†ç±»</a></li>
            
        
            
                <li><a href="/about/">ğŸŒŸå…³äº</a></li>
            
        
    </ul>
</div>

                    
                    

                    
                    

                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">
    

    
        
            
                <div class="post-main-title" style="text-align: center;">
                    çº¿ç¨‹æ± å®ç°
                </div>
            
        
      
    

    

        
            <div class="post-head-meta-center">
        
                
                    <span>æœ€è¿‘æ›´æ–°ï¼š2025-11-17</span> 
                
                
                    
                        &nbsp; | &nbsp;
                    
                     <span>å­—æ•°æ€»è®¡ï¼š4.1k</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span>é˜…è¯»ä¼°æ—¶ï¼š17åˆ†é’Ÿ</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span id="busuanzi_container_page_pv">
                        é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>æ¬¡
                    </span>
                
            </div>
    

    <div class="post-md">
        
        <div class=".article-gallery"><h3 id="å¸¸è§æ± å¼ç»“æ„">å¸¸è§æ± å¼ç»“æ„</h3>
<table style="width:100%;">
<colgroup>
<col style="width: 31%">
<col style="width: 36%">
<col style="width: 31%">
</colgroup>
<thead>
<tr>
<th style="text-align: left;">æ± ç±»å‹</th>
<th style="text-align: left;">æè¿°</th>
<th style="text-align: left;">åº”ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">çº¿ç¨‹æ± (Thread Pool)</td>
<td style="text-align: left;">å¤ç”¨å›ºå®šæ•°é‡çš„çº¿ç¨‹æ¥å¤„ç†å¤§é‡ä»»åŠ¡</td>
<td style="text-align: left;">å¹¶å‘æœåŠ¡å™¨ã€ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ</td>
</tr>
<tr>
<td style="text-align: left;">è¿æ¥æ± (Connection Pool)</td>
<td style="text-align: left;">å¤ç”¨æ•°æ®åº“è¿æ¥ã€HTTPè¿æ¥ç­‰èµ„æº</td>
<td style="text-align: left;">WebæœåŠ¡è®¿é—®æ•°æ®åº“/ç¼“å­˜æ—¶</td>
</tr>
<tr>
<td style="text-align: left;">å†…å­˜æ± (Memory Pool)</td>
<td style="text-align: left;">æå‰ç”³è¯·å†…å­˜å—ï¼Œé¿å…é¢‘ç¹ malloc/free</td>
<td style="text-align: left;">æ¸¸æˆå¼€å‘ã€ç½‘ç»œç¼“å†²åŒº</td>
</tr>
<tr>
<td style="text-align: left;">å¯¹è±¡æ± (Object Pool)</td>
<td style="text-align: left;">ç®¡ç†æŸä¸€ç±»å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ(é€šå¸¸å¸¦åˆå§‹åŒ–æˆæœ¬)</td>
<td style="text-align: left;">å›¾å½¢å¯¹è±¡ã€æ•°æ®åº“å®ä½“ã€Socket</td>
</tr>
<tr>
<td style="text-align: left;">åç¨‹æ± (Coroutine Pool)</td>
<td style="text-align: left;">å¾ªç¯å¤ç”¨ä¸€å®šæ•°é‡çš„åç¨‹ç»“æ„</td>
<td style="text-align: left;">é«˜å¹¶å‘æœåŠ¡ç«¯ã€å¼‚æ­¥æ¡†æ¶</td>
</tr>
<tr>
<td style="text-align: left;">çº¿ç¨‹æœ¬åœ°æ± (Thread-Local Pool)</td>
<td style="text-align: left;">æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯¹è±¡æ± /å†…å­˜æ± </td>
<td style="text-align: left;">é¿å…åŠ é”ã€æå‡å¹¶å‘æ€§èƒ½</td>
</tr>
</tbody>
</table>
<p><strong>æ± å¼ç»“æ„çš„ä½œç”¨ï¼š</strong></p>
<ol type="1">
<li><p>é¿å…é¢‘ç¹åˆ›å»º/é”€æ¯èµ„æº</p>
<ul>
<li><p>æ¯”å¦‚åˆ›å»ºçº¿ç¨‹ã€å»ºç«‹æ•°æ®åº“è¿æ¥ã€åˆ†é…å¤§å†…å­˜éƒ½æ˜¯æ˜‚è´µæ“ä½œï¼›</p></li>
<li><p>æ± åŒ–åï¼Œè¿™äº›èµ„æºåªåˆ›å»ºä¸€æ¬¡ï¼Œå¤šæ¬¡ä½¿ç”¨ï¼Œé¿å…é¢‘ç¹ç³»ç»Ÿè°ƒç”¨ã€‚</p></li>
</ul></li>
<li><p>èµ„æºå¤ç”¨ï¼Œé™ä½ç³»ç»Ÿå¼€é”€</p>
<ul>
<li><p>é¿å…äº†æ¯æ¬¡æ–°å»ºèµ„æºçš„æ—¶é—´å’Œå†…å­˜åˆ†é…ï¼›</p></li>
<li><p>å‡å°‘ CPU è°ƒåº¦ã€å†…å­˜ç¢ç‰‡ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡ã€‚</p></li>
</ul></li>
<li><p>é›†ä¸­ç®¡ç†èµ„æºï¼Œä¾¿äºæ§åˆ¶å’Œé™åˆ¶</p>
<ul>
<li><p>æ± å¯ä»¥ç»Ÿä¸€é™åˆ¶èµ„æºæ•°é‡ï¼Œé˜²æ­¢èµ„æºè€—å°½(å¦‚è¿æ¥æ•°ã€çº¿ç¨‹æ•°)ï¼›</p></li>
<li><p>ç®¡ç†èµ·æ¥æ›´æœ‰åºï¼Œä¹Ÿæ–¹ä¾¿ç›‘æ§å’Œè°ƒä¼˜ã€‚</p></li>
</ul></li>
<li><p>æå‡æ€§èƒ½å’Œå“åº”é€Ÿåº¦</p>
<ul>
<li><p>æ¯”å¦‚è¯·æ±‚åˆ°æ¥æ—¶ï¼Œç›´æ¥ä»æ± ä¸­å–å‡ºèµ„æºï¼Œå‡ ä¹æ— ç­‰å¾…ï¼›</p></li>
<li><p>å°¤å…¶åœ¨é«˜å¹¶å‘åœºæ™¯ï¼Œæ± åŒ–æŠ€æœ¯æ˜¯æå‡ QPS çš„é‡è¦æ‰‹æ®µã€‚</p></li>
</ul></li>
</ol>
<hr>
<h3 id="çº¿ç¨‹æ± ">çº¿ç¨‹æ± </h3>
<p><span style="color: red;">çº¿ç¨‹æ± æ˜¯é¢„å…ˆåˆ›å»ºå¥½çš„ä¸€ç»„çº¿ç¨‹ï¼Œåœ¨æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™å¤ç”¨è¿™ç»„çº¿ç¨‹ï¼Œå¯ä»¥é™ä½ç³»ç»Ÿåˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¸¦æ¥çš„å¼€é”€ã€‚</span></p>
<h5 id="çº¿ç¨‹æ± ä½œç”¨">çº¿ç¨‹æ± ä½œç”¨</h5>
<p>â€‹å¦‚æœæŸç±»ä»»åŠ¡ç‰¹åˆ«è€—æ—¶ï¼Œé‚£ä¹ˆä»–ä¼šä¸¥é‡å½±å“è¯¥çº¿ç¨‹å¤„ç†å…¶ä»–ä»»åŠ¡(åŒ…æ‹¬é‡è®¡ç®—ä»»åŠ¡ï¼ŒIOä»»åŠ¡)ï¼Œè§£å†³æ–¹å¼å°±æ˜¯å°†è¿™ç±»ä»»åŠ¡æ”¾åˆ°å…¶ä»–çº¿ç¨‹æ‰§è¡Œï¼Œå¼‚æ­¥æ‰§è¡Œéœ€è¦ä¸Šä¸‹æ–‡å’Œæ‰§è¡Œå‡½æ•°ï¼Œä»è€Œè¾¾åˆ°å……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æºã€å¤ç”¨ç°åœºèµ„æºã€å¼‚æ­¥æ‰§è¡Œè€—æ—¶ä»»åŠ¡çš„ä½œç”¨ã€‚
è€Œé¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¼šå¸¦æ¥å¾ˆå¤§çš„å¼€é”€ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥é™ä½è¿™éƒ¨åˆ†å¼€é”€ã€‚</p>
<ul>
<li><p>çº¿ç¨‹æ± ä¸ä¼šå ç”¨æ ¸å¿ƒçº¿ç¨‹ï¼Œå¼‚æ­¥æ‰§è¡Œè€—æ—¶ä»»åŠ¡ã€‚(ç³»ç»Ÿä¸ä¼šè¢«é‡è®¡ç®—ä»»åŠ¡ã€IOæ“ä½œé˜»å¡)</p></li>
<li><p>å¹¶å‘ï¼Œæé«˜ç³»ç»Ÿçš„æ€§èƒ½</p></li>
</ul>
<h5 id="çº¿ç¨‹æ± å·¥ä½œæœºåˆ¶">çº¿ç¨‹æ± å·¥ä½œæœºåˆ¶</h5>
<p>çº¿ç¨‹æ± çš„å·¥ä½œæœºåˆ¶åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼šä»»åŠ¡æäº¤ã€ä»»åŠ¡é˜Ÿåˆ—å’Œçº¿ç¨‹ç®¡ç†ã€‚</p>
<ol type="1">
<li><strong>ä»»åŠ¡æäº¤</strong>ï¼šä»»åŠ¡æäº¤æ˜¯æŒ‡å°†ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± ï¼Œç”±çº¿ç¨‹æ± ç®¡ç†ä»»åŠ¡çš„è°ƒåº¦å’Œæ‰§è¡Œï¼Œå¼€å‘è€…åªéœ€å°†ä»»åŠ¡å‡½æ•°å°è£…ä¸ºä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡(å¦‚<code>std::function&lt;void()&gt;</code>)ï¼Œå¹¶å°†å…¶æäº¤åˆ°çº¿ç¨‹æ± å³å¯ã€‚</li>
<li><strong>ä»»åŠ¡é˜Ÿåˆ—</strong>ï¼šä»»åŠ¡é˜Ÿåˆ—ç”¨äºå­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ç©ºé—²æ—¶ï¼Œä¼šä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œã€‚ä»»åŠ¡é˜Ÿåˆ—é€šå¸¸ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ï¼Œå¦‚ <code>std::queue</code> é…åˆ <code>std::mutex</code> è¿›è¡ŒåŒæ­¥ã€‚</li>
<li><strong>çº¿ç¨‹ç®¡ç†</strong>ï¼šçº¿ç¨‹ç®¡ç†è´Ÿè´£çº¿ç¨‹çš„åˆ›å»ºã€é”€æ¯å’Œè°ƒåº¦ï¼Œçº¿ç¨‹æ± åœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºå›ºå®šæ•°é‡çš„çº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹åœ¨ç¨‹åºè¿è¡ŒæœŸé—´æŒç»­å­˜åœ¨ï¼Œå¹¶ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡æ‰§è¡Œã€‚å½“ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°æœ‰æ–°ä»»åŠ¡æäº¤ã€‚</li>
</ol>
<center>
<a href="1.png" class="gallery-item" style="box-shadow: none;"> <img src="1.png" width="90%"></a>
</center>
<h3 id="å›ºå®šå¤§å°çº¿ç¨‹æ± çš„cå®ç°c17">å›ºå®šå¤§å°çº¿ç¨‹æ± çš„C++å®ç°(C++17)</h3>
<p><code>thread_pool.h</code>
</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;shared_mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;type_traits&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;optional&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> ThreadPool</span></span><br><span class="line"><span class="comment"> ç®€å•çš„çº¿ç¨‹æ± å®ç°ï¼š</span></span><br><span class="line"><span class="comment"> - æ„é€ æ—¶åˆ›å»ºæŒ‡å®šæ•°é‡çš„å·¥ä½œçº¿ç¨‹</span></span><br><span class="line"><span class="comment"> - submit æäº¤ä»»åŠ¡å¹¶è¿”å› std::future ç”¨äºè·å–ç»“æœ/å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> - wait_done ç­‰å¾…å½“å‰å·²æäº¤ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼ˆä¸é˜»æ­¢æ–°ä»»åŠ¡æäº¤ï¼‰</span></span><br><span class="line"><span class="comment"> - shutdown å…³é—­çº¿ç¨‹æ± å¹¶ç­‰å¾…æ‰€æœ‰å·¥ä½œçº¿ç¨‹é€€å‡º</span></span><br><span class="line"><span class="comment"> çº¿ç¨‹å®‰å…¨è¯´æ˜ï¼š</span></span><br><span class="line"><span class="comment"> - ä»»åŠ¡é˜Ÿåˆ—å’Œç›¸å…³çŠ¶æ€ç”± queue_mutex ä¿æŠ¤</span></span><br><span class="line"><span class="comment"> - stop å’Œ active_task_cnt ä½¿ç”¨åŸå­å˜é‡ä»¥å‡å°‘é”ç«äº‰</span></span><br><span class="line"><span class="comment"> - submit åœ¨ stop ä¸º true æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œé˜²æ­¢åœ¨å…³é—­åç»§ç»­æäº¤ä»»åŠ¡</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// thread_countï¼šå·¥ä½œçº¿ç¨‹æ•°é‡ï¼ˆåº”ä¸ºæ­£æ•°ï¼‰</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">ThreadPool</span><span class="params">(<span class="type">int</span> thread_count)</span></span>;</span><br><span class="line">    ~<span class="built_in">ThreadPool</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// submit: æäº¤ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼ˆä»¥åŠå‚æ•°ï¼‰åˆ°çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="comment">// è¿”å› std::future&lt;R&gt;ï¼Œå½“ä»»åŠ¡è¢«æ‰§è¡Œå®Œæˆåå¯ä»¥è·å–è¿”å›å€¼æˆ–å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">auto</span> <span class="title">submit</span><span class="params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; std::future&lt;std::<span class="type">invoke_result_t</span>&lt;F, Args...&gt;&gt;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait_done: ç­‰å¾…å½“å‰é˜Ÿåˆ—ä¸­æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼ˆä¸é˜»æ­¢æ–°çš„ submitï¼‰</span></span><br><span class="line">    <span class="comment">// è¿™æ˜¯ä¸€ä¸ªå¿™ç­‰å¾…å®ç°ï¼ˆsleep 1msï¼‰ï¼Œé€‚ç”¨äºæµ‹è¯•å’Œç®€å•åœºæ™¯</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">wait_done</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// shutdown: å…³é—­çº¿ç¨‹æ± ï¼Œé˜»å¡ç›´åˆ°æ‰€æœ‰çº¿ç¨‹é€€å‡º</span></span><br><span class="line">    <span class="comment">// ä¸€æ—¦è°ƒç”¨ shutdownï¼Œsubmit å°†æŠ›å‡º runtime_error</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// å·¥ä½œçº¿ç¨‹ä¸»å¾ªç¯ï¼Œä»é˜Ÿåˆ—å–ä»»åŠ¡å¹¶æ‰§è¡Œ</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">worker_loop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::thread&gt; workers;               <span class="comment">// å·¥ä½œçº¿ç¨‹é›†åˆ</span></span><br><span class="line">    std::queue&lt;std::function&lt;<span class="type">void</span>()&gt;&gt; task_queue;   <span class="comment">// ä»»åŠ¡é˜Ÿåˆ—ï¼ŒæŒ‰æäº¤é¡ºåºæ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">    std::mutex queue_mutex;                         <span class="comment">// ä¿æŠ¤ task_queue å’Œä¸ä¹‹ç›¸å…³çš„ä¸´ç•ŒåŒº</span></span><br><span class="line">    std::condition_variable condition;              <span class="comment">// ç”¨äºé€šçŸ¥å·¥ä½œçº¿ç¨‹æœ‰æ–°ä»»åŠ¡æˆ–å…³é—­äº‹ä»¶</span></span><br><span class="line"></span><br><span class="line">    std::atomic&lt;<span class="type">bool</span>&gt; stop{<span class="literal">false</span>};                  <span class="comment">// æ ‡å¿—æ˜¯å¦å·²å…³é—­çº¿ç¨‹æ± ï¼ˆtrue è¡¨ç¤ºå…³é—­ä¸­/å·²å…³é—­ï¼‰</span></span><br><span class="line">    std::atomic&lt;<span class="type">int</span>&gt; active_task_cnt{<span class="number">0</span>};            <span class="comment">// å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ•°ï¼ˆä»…ç”¨äº wait_done åˆ¤æ–­ï¼‰</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="title">ThreadPool::ThreadPool</span><span class="params">(<span class="type">int</span> thread_count)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// åˆ›å»ºæŒ‡å®šæ•°é‡çš„å·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹è¿è¡Œ worker_loop</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; thread_count; ++i)</span><br><span class="line">    {</span><br><span class="line">        workers.<span class="built_in">emplace_back</span>(&amp;ThreadPool::worker_loop, <span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">ThreadPool::worker_loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    {</span><br><span class="line">        std::function&lt;<span class="type">void</span>()&gt; task;</span><br><span class="line"></span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// ç­‰å¾…æ¡ä»¶ï¼šè¦ä¹ˆæ˜¯ stop è¢«è®¾ç½®ï¼ˆå…³é—­ï¼‰ï¼Œè¦ä¹ˆé˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡</span></span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queue_mutex)</span></span>;</span><br><span class="line">            condition.<span class="built_in">wait</span>(lock,[<span class="keyword">this</span>](){<span class="keyword">return</span> stop.<span class="built_in">load</span>() || !task_queue.<span class="built_in">empty</span>();});</span><br><span class="line">            <span class="comment">// å¦‚æœçº¿ç¨‹æ± å·²åœä¸”æ²¡æœ‰ä»»åŠ¡ï¼Œå®‰å…¨é€€å‡ºè¯¥çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (stop &amp;&amp; task_queue.<span class="built_in">empty</span>())<span class="comment">//çº¿ç¨‹æ± è¢«å…³é—­ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œé€€å‡ºçº¿ç¨‹</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶æ ‡è®°ä¸ºæ­£åœ¨æ‰§è¡Œï¼ˆactive_task_cnt++ï¼‰</span></span><br><span class="line">            task = std::<span class="built_in">move</span>(task_queue.<span class="built_in">front</span>());</span><br><span class="line">            task_queue.<span class="built_in">pop</span>();</span><br><span class="line">            active_task_cnt++;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨ä¸´ç•ŒåŒºå¤–æ‰§è¡Œä»»åŠ¡ï¼Œç¡®ä¿å¹¶å‘æ‰§è¡Œæ—¶æœ€å°åŒ–é”æŒæœ‰æ—¶é—´</span></span><br><span class="line">        <span class="built_in">task</span>();</span><br><span class="line">        active_task_cnt--;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">ThreadPool::submit</span><span class="params">(F&amp;&amp; f, Args&amp;&amp;... args)</span> -&gt; std::future&lt;std::<span class="type">invoke_result_t</span>&lt;F, Args...&gt;&gt;</span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> ReturnType = std::<span class="type">invoke_result_t</span>&lt;F, Args...&gt;;</span><br><span class="line">    <span class="comment">// å°†å¯è°ƒç”¨å¯¹è±¡å’Œå‚æ•°ç»‘å®šä¸ºæ— å‚æ•°çš„ packaged_taskï¼Œæ–¹ä¾¿æ”¾å…¥é˜Ÿåˆ—æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">auto</span> task_ptr = std::make_shared&lt;std::packaged_task&lt;<span class="built_in">ReturnType</span>()&gt;&gt;(std::<span class="built_in">bind</span>(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...));</span><br><span class="line"></span><br><span class="line">    std::future&lt;ReturnType&gt; future = task_ptr-&gt;<span class="built_in">get_future</span>();</span><br><span class="line"></span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// åœ¨ä¸´ç•ŒåŒºå†…å¯¹é˜Ÿåˆ—å’Œ stop çŠ¶æ€è¿›è¡Œæ£€æŸ¥ä¸ä¿®æ”¹</span></span><br><span class="line">        <span class="function">std::scoped_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queue_mutex)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (stop)</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// å¦‚æœçº¿ç¨‹æ± å·²è¢«å…³é—­ï¼Œç¦æ­¢æäº¤æ–°ä»»åŠ¡ï¼Œé€šçŸ¥è°ƒç”¨è€…</span></span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">runtime_error</span>(<span class="string">"ThreadPool::submit: stopped"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// å°†ä»»åŠ¡ä»¥ lambda å½¢å¼æ”¾å…¥é˜Ÿåˆ—ï¼›lambda å†…è°ƒç”¨ packaged_taskï¼Œä»¥è§¦å‘ future çš„çŠ¶æ€æ›´æ–°</span></span><br><span class="line">        task_queue.<span class="built_in">emplace</span>([task_ptr](){ std::<span class="built_in">invoke</span>(*task_ptr); });<span class="comment">//ä½¿ç”¨ std::invoke è°ƒç”¨ packaged_task</span></span><br><span class="line">        <span class="comment">//task_queue.emplace([task_ptr]() { (*task_ptr)(); });//ç›´æ¥è°ƒç”¨ packaged_task çš„ operator()</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…çš„å·¥ä½œçº¿ç¨‹æ¥å¤„ç†æ–°ä»»åŠ¡</span></span><br><span class="line">    condition.<span class="built_in">notify_one</span>();</span><br><span class="line">    <span class="keyword">return</span> future;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">ThreadPool::wait_done</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// ç®€å•è½®è¯¢å®ç°ï¼šå½“é˜Ÿåˆ—ä¸ºç©ºä¸”æ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ—¶è¿”å›</span></span><br><span class="line">    <span class="comment">// æ³¨æ„ï¼šæ­¤æ–¹æ³•å¯èƒ½ä¼šåœ¨æäº¤å¤§é‡çŸ­ä»»åŠ¡æ—¶å¯¼è‡´çŸ­æš‚å¿™ç­‰å¾…</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (task_queue.<span class="built_in">empty</span>() &amp;&amp; active_task_cnt.<span class="built_in">load</span>() == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">1</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">ThreadPool::shutdown</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// åœ¨å…³é—­è¿‡ç¨‹ä¸­è®¾ç½® stop æ ‡å¿—ï¼Œé˜²æ­¢åç»­ submit æˆåŠŸ</span></span><br><span class="line">        <span class="function">std::scoped_lock <span class="title">lock</span><span class="params">(queue_mutex)</span></span>;</span><br><span class="line">        stop = <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é€šçŸ¥æ‰€æœ‰å·¥ä½œçº¿ç¨‹ä»¥ä¾¿å®ƒä»¬é€€å‡ºï¼ˆå½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼‰</span></span><br><span class="line">    condition.<span class="built_in">notify_all</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…æ‰€æœ‰çº¿ç¨‹é€€å‡ºï¼Œç¡®ä¿èµ„æºæ­£ç¡®å›æ”¶</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; thread : workers)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (thread.<span class="built_in">joinable</span>())  thread.<span class="built_in">join</span>(); <span class="comment">// ç­‰å¾…çº¿ç¨‹å°†çº¿ç¨‹æ± ä¸­å‰©ä½™ä»»åŠ¡æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> ThreadPool::~<span class="built_in">ThreadPool</span>()</span><br><span class="line">{</span><br><span class="line">    <span class="comment">// ææ„æ—¶ä¿è¯å·²å…³é—­çº¿ç¨‹æ± ï¼ˆshutdown å·²å¹‚ç­‰ï¼‰</span></span><br><span class="line">    <span class="built_in">shutdown</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<h5 id="å…·ä½“ç»†èŠ‚">å…·ä½“ç»†èŠ‚</h5>
<h6 id="å·¥ä½œçº¿ç¨‹ä¸ä»»åŠ¡é˜Ÿåˆ—çš„åŒæ­¥å®ç°">å·¥ä½œçº¿ç¨‹ä¸ä»»åŠ¡é˜Ÿåˆ—çš„åŒæ­¥å®ç°</h6>
<p>é€šè¿‡æ¡ä»¶å˜é‡ <code>std::condition_variable</code> å’Œäº’æ–¥é” <code>std::mutex</code>å®ç°çº¿ç¨‹é—´åŒæ­¥ï¼š</p>
<p><strong>å·¥ä½œçº¿ç¨‹ï¼š</strong>
</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="comment">//ä¸Šé”ï¼Œè¿™é‡Œä½¿ç”¨std::unique_lockï¼Œä¸è¦ä½¿ç”¨å…¶ä»–ç±»å‹</span></span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(queue_mutex)</span></span>;</span><br><span class="line">    <span class="comment">//è§£é”äº’æ–¥é‡ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€</span></span><br><span class="line">    condition.<span class="built_in">wait</span>(lock,[<span class="keyword">this</span>](){<span class="keyword">return</span> stop.<span class="built_in">load</span>() || !task_queue.<span class="built_in">empty</span>();});</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><strong>ä»»åŠ¡é˜Ÿåˆ—ï¼š</strong>
</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å”¤é†’ä¸€ä¸ªç­‰å¾…çš„å·¥ä½œçº¿ç¨‹</span></span><br><span class="line">condition.<span class="built_in">notify_one</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šçŸ¥æ‰€æœ‰å·¥ä½œçº¿ç¨‹</span></span><br><span class="line">condition.<span class="built_in">notify_all</span>();</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><strong>æ¡ä»¶ç­‰å¾…ï¼š</strong>
</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">condition.<span class="built_in">wait</span>(lock, predicate);</span><br></pre></td></tr></tbody></table></figure><p></p>
<ul>
<li><p><strong>åŸå­æ“ä½œ</strong>ï¼šè§£é”äº’æ–¥é‡å¹¶è®©å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€</p></li>
<li><p><strong>å”¤é†’æ¡ä»¶</strong>ï¼šå½“å…¶ä»–çº¿ç¨‹è°ƒç”¨ <code>condition.notify_one()</code> æˆ– <code>condition.notify_all()</code> æ—¶è¢«å”¤é†’ï¼Œæ£€æŸ¥è°“è¯æ¡ä»¶(lambdaè¡¨è¾¾å¼)ï¼Œè¿”å› trueæ—¶ï¼Œçº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼›è¿”å› falseæ—¶ï¼Œçº¿ç¨‹ç»§ç»­ç­‰å¾…ã€‚</p></li>
</ul>
<h6 id="ç§»åŠ¨è¯­ä¹‰">ç§»åŠ¨è¯­ä¹‰</h6>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶æ ‡è®°ä¸ºæ­£åœ¨æ‰§è¡Œï¼ˆactive_task_cnt++ï¼‰</span></span><br><span class="line">task = std::<span class="built_in">move</span>(task_queue.<span class="built_in">front</span>());</span><br><span class="line">task_queue.<span class="built_in">pop</span>();</span><br></pre></td></tr></tbody></table></figure>
<p><code>task_queue.front()</code>è¿”å›çš„æ˜¯ä¸€ä¸ª <code>std::function&lt;void()&gt;</code> ç±»å‹çš„å·¦å€¼ï¼Œä¸ºäº†ä½¿ç”¨ç§»åŠ¨èµ‹å€¼ä»»åŠ¡ï¼ˆå¯ä»¥å‡å°‘æ‹·è´ä»»åŠ¡çš„å¼€é”€ï¼‰ï¼Œéœ€è¦ä½¿ç”¨ <code>std::move()</code> å°†å·¦å€¼å¼ºåˆ¶è½¬æ¢ä¸ºå³å€¼å¼•ç”¨ <code>std::function&lt;void()&gt;&amp;&amp;</code>ï¼Œä»è€Œè§¦å‘ç§»åŠ¨è¯­ä¹‰ã€‚ä¹‹å <code>task_queue.pop()</code> å°†ä¸¢å¤±èµ„æºæ‰€æœ‰æƒçš„å…ƒç´ å¼¹å‡ºã€‚</p>
<h6 id="threadpoolsubmitè¯¦è§£">ThreadPool::submitè¯¦è§£</h6>
<ol type="1">
<li><p><code>template &lt;typename F, typename... Args&gt;</code>ï¼š
æ¨¡æ¿å‡½æ•°ï¼Œå…¶ä¸­ <code>typename... Args&gt;</code> å£°æ˜ä¸€ä¸ªå¯å˜å‚æ•°æ¨¡æ¿ï¼ˆå‚æ•°åŒ…ï¼‰ï¼Œè¡¨ç¤ºå¯æ¥å—ä»»æ„æ•°é‡ã€ä»»æ„ç±»å‹çš„å‚æ•°ã€‚</p></li>
<li><p><code>std::invoke_result_t&lt;F, Args...&gt;</code>ï¼š
<strong>åœ¨ç¼–è¯‘æ—¶æ¨å¯¼å‡º</strong>è°ƒç”¨ Få‡½æ•°å¹¶ä¼ å…¥ Argsâ€¦å‚æ•°åçš„submitå‡½æ•°<strong>è¿”å›å€¼ç±»å‹</strong>ã€‚</p></li>
<li><p><code>std::future&lt;&gt;</code>ï¼Œè¿”å›ä¸€ä¸ªæœªæ¥å¯¹è±¡ï¼Œç”¨äºè·å–å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œçš„ç»“æœã€‚</p></li>
<li><p><code>std::packaged_task&lt;ReturnType()&gt;</code>ç”¨äºå°†ä»»æ„å¯è°ƒç”¨å‡½æ•°å°è£…ä¸ºï¼Œå¯å¼‚æ­¥è·å–ç»“æœçš„å¯è°ƒç”¨å¯¹è±¡ã€‚
</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">complex_calculation</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>{</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> x * y + (x + y);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// åˆ›å»º packaged_task</span></span><br><span class="line">    <span class="function">std::packaged_task&lt;<span class="title">int</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>)</span>&gt; <span class="title">task</span><span class="params">(complex_calculation)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å– futureï¼ˆå¿…é¡»åœ¨æ‰§è¡Œä»»åŠ¡å‰è·å–ï¼‰</span></span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; fut = task.<span class="built_in">get_future</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éœ€è¦æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹</span></span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">(std::move(task), <span class="number">5</span>, <span class="number">3</span>)</span></span>;  <span class="comment">// packaged_task åªèƒ½ç§»åŠ¨ï¼Œä¸èƒ½æ‹·è´</span></span><br><span class="line">    t.<span class="built_in">detach</span>();  <span class="comment">// æˆ– t.join()</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–ç»“æœ</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">"Result: "</span> &lt;&lt; fut.<span class="built_in">get</span>() &lt;&lt; std::endl;  <span class="comment">// 5 * 3 + (5+3) = 15+8=23</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p></li>
<li><p><code>std::make_shared&gt;()</code> åˆ›å»ºä¸€ä¸ªç®¡ç†å¯è°ƒç”¨å¯¹è±¡å†…å­˜çš„std::shared_ptræ™ºèƒ½æŒ‡é’ˆï¼Œç”±äºpackaged_task åªèƒ½ç§»åŠ¨ï¼Œä¸èƒ½æ‹·è´ï¼Œæ‰€ä»¥ä½¿ç”¨æŒ‡é’ˆæ–¹ä¾¿åç»­ä½¿ç”¨lambdaè¡¨è¾¾å¼å°†å¯è°ƒç”¨å¯¹è±¡å­˜å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚</p></li>
<li><p><code>std::bind(std::forward&lt;F&gt;(f), std::forward&lt;Args&gt;(args)...)</code>ï¼š<strong>ä¸€ä¸ªå‡½æ•°é€‚é…å™¨</strong>ï¼Œå°†å¯è°ƒç”¨å¯¹è±¡få’Œå…¶å‚æ•°argsâ€¦â€œç»‘å®šâ€åœ¨ä¸€èµ·ï¼Œ<strong>ç”Ÿæˆä¸€ä¸ªæ–°çš„ã€æ— å‚æ•°çš„å¯è°ƒç”¨å®ä½“</strong>ã€‚</p></li>
<li><p><code>std::forward&lt;F&gt;(f)</code>ä¸ <code>std::forward&lt;Args&gt;(args)...</code>ï¼šå®Œç¾è½¬å‘ã€‚ä¿ç•™ä¼ å…¥çš„å¯è°ƒç”¨å¯¹è±¡få’Œå‚æ•°argsâ€¦çš„åŸå§‹å€¼ç±»åˆ«ï¼ˆæ˜¯å·¦å€¼è¿˜æ˜¯å³å€¼ï¼‰ã€‚</p></li>
<li><p><code>std::invoke</code>:æ˜¯ C++17æ ‡å‡†åº“ä¸­å¼•å…¥çš„ä¸€ä¸ªå‡½æ•°æ¨¡æ¿ï¼Œæä¾›äº†ä¸€ç§ç»Ÿä¸€çš„å¯è°ƒç”¨å¯¹è±¡çš„è°ƒç”¨è¯­æ³•ï¼Œæ— è®ºæ˜¯è°ƒç”¨æ™®é€šå‡½æ•°ã€å‡½æ•°æŒ‡é’ˆã€ç±»æˆå‘˜å‡½æ•°æŒ‡é’ˆã€ä»¿å‡½æ•°ã€std::functionã€ç±»æˆå‘˜è¿˜æ˜¯lambdaè¡¨è¾¾å¼ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ç›¸åŒçš„æ–¹å¼è¿›è¡Œè°ƒç”¨ã€‚
</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‡½æ•°åŸå‹</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Fn, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">invoke</span><span class="params">(Fn&amp;&amp; fn, Args&amp;&amp;... args)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨æ–¹å¼</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;type_traits&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Foo</span></span><br><span class="line">{</span><br><span class="line">    <span class="built_in">Foo</span>(<span class="type">int</span> num) : <span class="built_in">num_</span>(num) {}</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print_add</span><span class="params">(<span class="type">int</span> i)</span> <span class="type">const</span> </span>{ std::cout &lt;&lt; num_ + i &lt;&lt; <span class="string">'\n'</span>; }</span><br><span class="line">    <span class="type">int</span> num_;</span><br><span class="line">};</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print_num</span><span class="params">(<span class="type">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    std::cout &lt;&lt; i &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">PrintNum</span></span><br><span class="line">{</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">int</span> i)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        std::cout &lt;&lt; i &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// è°ƒç”¨è‡ªç”±å‡½æ•°</span></span><br><span class="line">    std::<span class="built_in">invoke</span>(print_num, <span class="number">-9</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// è°ƒç”¨ lambda</span></span><br><span class="line">    std::<span class="built_in">invoke</span>([]() { <span class="built_in">print_num</span>(<span class="number">42</span>); });</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// è°ƒç”¨æˆå‘˜å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="type">const</span> Foo <span class="title">foo</span><span class="params">(<span class="number">314159</span>)</span></span>;</span><br><span class="line">    std::<span class="built_in">invoke</span>(&amp;Foo::print_add, foo, <span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// è°ƒç”¨ï¼ˆè®¿é—®ï¼‰æ•°æ®æˆå‘˜</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">"num_ï¼š"</span> &lt;&lt; std::<span class="built_in">invoke</span>(&amp;Foo::num_, foo) &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// è°ƒç”¨å‡½æ•°å¯¹è±¡</span></span><br><span class="line">    std::<span class="built_in">invoke</span>(<span class="built_in">PrintNum</span>(), <span class="number">18</span>);</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__cpp_lib_invoke_r)</span></span><br><span class="line">    <span class="keyword">auto</span> add = [](<span class="type">int</span> x, <span class="type">int</span> y) { <span class="keyword">return</span> x + y; };</span><br><span class="line">    <span class="keyword">auto</span> ret = std::<span class="built_in">invoke_r</span>&lt;<span class="type">float</span>&gt;(add, <span class="number">11</span>, <span class="number">22</span>);</span><br><span class="line">    <span class="built_in">static_assert</span>(std::<span class="built_in">is_same</span>&lt;<span class="keyword">decltype</span>(ret), <span class="type">float</span>&gt;());</span><br><span class="line">    std::cout &lt;&lt; ret &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">    std::<span class="built_in">invoke_r</span>&lt;<span class="type">void</span>&gt;(print_num, <span class="number">44</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p></li>
</ol>
<h3 id="åŠ¨æ€å¤§å°çº¿ç¨‹æ± ">åŠ¨æ€å¤§å°çº¿ç¨‹æ± </h3>
<p><strong>åŠ¨æ€å¤§å°çº¿ç¨‹æ± æ ¹æ®ä»»åŠ¡è´Ÿè½½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ•°é‡ã€‚</strong></p>
<ul>
<li><p>å½“ä»»åŠ¡è´Ÿè½½å¢åŠ æ—¶ï¼Œçº¿ç¨‹æ± å¯ä»¥åˆ›å»ºæ›´å¤šçº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ï¼›</p></li>
<li><p>å½“ä»»åŠ¡è´Ÿè½½å‡å°‘æ—¶ï¼Œçº¿ç¨‹æ± å¯ä»¥é”€æ¯ç©ºé—²çº¿ç¨‹ä»¥èŠ‚çœèµ„æºã€‚è¿™ç§çº¿ç¨‹æ± é€‚ç”¨äºä»»åŠ¡è´Ÿè½½æ³¢åŠ¨è¾ƒå¤§çš„åœºæ™¯ï¼Œå¦‚é«˜å³°æœŸçš„è¯·æ±‚å¤„ç†å’Œæ‰¹é‡æ•°æ®å¤„ç†ã€‚</p></li>
</ul>
<p>åŠ¨æ€å¤§å°çº¿ç¨‹æ± çš„ç¤ºä¾‹ä»£ç ï¼š
åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>DynamicThreadPool</code> ç±»å¯ä»¥æ ¹æ®ä»»åŠ¡è´Ÿè½½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± çš„å¤§å°ã€‚å½“ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ•°é‡è¶…è¿‡å½“å‰çº¿ç¨‹æ•°é‡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºæ–°çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ï¼›å½“ä»»åŠ¡å‡å°‘æ—¶ï¼Œçº¿ç¨‹æ± ä¼šä¿æŒçº¿ç¨‹çš„æœ€ä½æ•°é‡ï¼Œä»¥èŠ‚çœèµ„æºã€‚</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DynamicThreadPool</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DynamicThreadPool</span>(<span class="type">size_t</span> minThreads, <span class="type">size_t</span> maxThreads)</span><br><span class="line">        : <span class="built_in">mMinThreads</span>(minThreads), <span class="built_in">mMaxThreads</span>(maxThreads) {</span><br><span class="line">        <span class="built_in">start</span>(minThreads);</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    ~<span class="built_in">DynamicThreadPool</span>() {</span><br><span class="line">        <span class="built_in">stop</span>();</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">enqueue</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; task)</span> </span>{</span><br><span class="line">        {</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mEventMutex)</span></span>;</span><br><span class="line">            mTasks.<span class="built_in">emplace</span>(std::<span class="built_in">move</span>(task));</span><br><span class="line">        }</span><br><span class="line">        mEventVar.<span class="built_in">notify_one</span>();</span><br><span class="line">        <span class="built_in">managePoolSize</span>();</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">size_t</span> mMinThreads;</span><br><span class="line">    <span class="type">size_t</span> mMaxThreads;</span><br><span class="line">    std::vector&lt;std::thread&gt; mThreads;</span><br><span class="line">    std::condition_variable mEventVar;</span><br><span class="line">    std::mutex mEventMutex;</span><br><span class="line">    <span class="type">bool</span> mStopping = <span class="literal">false</span>;</span><br><span class="line">    std::queue&lt;std::function&lt;<span class="type">void</span>()&gt;&gt; mTasks;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">(<span class="type">size_t</span> numThreads)</span> </span>{</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; numThreads; ++i) {</span><br><span class="line">            mThreads.<span class="built_in">emplace_back</span>([=] {</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                    std::function&lt;<span class="built_in">void</span>()&gt; task;</span><br><span class="line">                    {</span><br><span class="line">                        std::unique_lock&lt;std::mutex&gt; <span class="built_in">lock</span>(mEventMutex);</span><br><span class="line">                        mEventVar.<span class="built_in">wait</span>(lock, [=] { <span class="keyword">return</span> mStopping || !mTasks.<span class="built_in">empty</span>(); });</span><br><span class="line">                        <span class="keyword">if</span> (mStopping &amp;&amp; mTasks.<span class="built_in">empty</span>())</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        task = std::<span class="built_in">move</span>(mTasks.<span class="built_in">front</span>());</span><br><span class="line">                        mTasks.<span class="built_in">pop</span>();</span><br><span class="line">                    }</span><br><span class="line">                    <span class="built_in">task</span>();</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">stop</span><span class="params">()</span> </span>{</span><br><span class="line">        {</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mEventMutex)</span></span>;</span><br><span class="line">            mStopping = <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        mEventVar.<span class="built_in">notify_all</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;thread : mThreads)</span><br><span class="line">            thread.<span class="built_in">join</span>();</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">managePoolSize</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="type">size_t</span> currentThreads = mThreads.<span class="built_in">size</span>();</span><br><span class="line">        <span class="keyword">if</span> (mTasks.<span class="built_in">size</span>() &gt; currentThreads &amp;&amp; currentThreads &lt; mMaxThreads) {</span><br><span class="line">            mThreads.<span class="built_in">emplace_back</span>([=] {</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                    std::function&lt;<span class="built_in">void</span>()&gt; task;</span><br><span class="line">                    {</span><br><span class="line">                        std::unique_lock&lt;std::mutex&gt; <span class="built_in">lock</span>(mEventMutex);</span><br><span class="line">                        mEventVar.<span class="built_in">wait</span>(lock, [=] { <span class="keyword">return</span> mStopping || !mTasks.<span class="built_in">empty</span>(); });</span><br><span class="line">                        <span class="keyword">if</span> (mStopping &amp;&amp; mTasks.<span class="built_in">empty</span>())</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        task = std::<span class="built_in">move</span>(mTasks.<span class="built_in">front</span>());</span><br><span class="line">                        mTasks.<span class="built_in">pop</span>();</span><br><span class="line">                    }</span><br><span class="line">                    <span class="built_in">task</span>();</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">exampleTask</span><span class="params">()</span> </span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"Task executed by thread "</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">DynamicThreadPool <span class="title">pool</span><span class="params">(<span class="number">2</span>, <span class="number">8</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i) {</span><br><span class="line">        pool.<span class="built_in">enqueue</span>(exampleTask);</span><br><span class="line">    }</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="çº¿ç¨‹æ± çš„ä»»åŠ¡è°ƒåº¦ç­–ç•¥">çº¿ç¨‹æ± çš„ä»»åŠ¡è°ƒåº¦ç­–ç•¥</h3>
<p>çº¿ç¨‹æ± çš„ä»»åŠ¡è°ƒåº¦ç­–ç•¥å†³å®šäº†ä»»åŠ¡åœ¨ä½•æ—¶ä»¥åŠç”±å“ªä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œï¼Œå¸¸è§çš„ä»»åŠ¡è°ƒåº¦ç­–ç•¥åŒ…æ‹¬å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰ã€åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰å’Œä¼˜å…ˆçº§è°ƒåº¦ã€‚</p>
<ul>
<li><p><strong>å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰</strong>ï¼šä»»åŠ¡æŒ‰ç…§æäº¤çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œä¿è¯ä»»åŠ¡çš„å…¬å¹³æ€§ã€‚é€‚ç”¨äºå¤§å¤šæ•°é€šç”¨ä»»åŠ¡è°ƒåº¦åœºæ™¯ã€‚</p></li>
<li><p><strong>åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰</strong>ï¼šæœ€æ–°æäº¤çš„ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œï¼Œé€‚ç”¨äºéœ€è¦å¿«é€Ÿå“åº”æœ€æ–°ä»»åŠ¡çš„åœºæ™¯ï¼Œå¦‚å®æ—¶æ•°æ®å¤„ç†ã€‚</p></li>
<li><p><strong>ä¼˜å…ˆçº§è°ƒåº¦</strong>ï¼šä»»åŠ¡æ ¹æ®ä¼˜å…ˆçº§è¿›è¡Œè°ƒåº¦ï¼Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œã€‚é€‚ç”¨äºéœ€è¦åŒºåˆ†ä»»åŠ¡é‡è¦æ€§å’Œç´§æ€¥æ€§çš„åœºæ™¯ï¼Œå¦‚å¤šçº§è¯·æ±‚å¤„ç†å’Œèµ„æºåˆ†é…ã€‚</p></li>
</ul>
<p>ä¼˜å…ˆçº§è°ƒåº¦ç¤ºä¾‹ï¼š
åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ<code>PriorityThreadPool</code> ç±»å®ç°äº†ä¸€ä¸ªåŸºäºä¼˜å…ˆçº§è°ƒåº¦çš„çº¿ç¨‹æ± ï¼Œä»»åŠ¡æ ¹æ®ä¼˜å…ˆçº§å…¥é˜Ÿï¼Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œã€‚è¿™ç§ç­–ç•¥ç¡®ä¿å…³é”®ä»»åŠ¡èƒ½å¤Ÿæ›´å¿«åœ°å¾—åˆ°å¤„ç†ï¼Œé€‚ç”¨äºéœ€è¦åŒºåˆ†ä»»åŠ¡é‡è¦æ€§å’Œç´§æ€¥æ€§çš„åœºæ™¯ã€‚
</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PriorityThreadPool</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">PriorityThreadPool</span>(<span class="type">size_t</span> numThreads) {</span><br><span class="line">        <span class="built_in">start</span>(numThreads);</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    ~<span class="built_in">PriorityThreadPool</span>() {</span><br><span class="line">        <span class="built_in">stop</span>();</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">enqueue</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; task, <span class="type">int</span> priority)</span> </span>{</span><br><span class="line">        {</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mEventMutex)</span></span>;</span><br><span class="line">            mTasks.<span class="built_in">emplace</span>(priority, std::<span class="built_in">move</span>(task));</span><br><span class="line">        }</span><br><span class="line">        mEventVar.<span class="built_in">notify_one</span>();</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Task</span> {</span><br><span class="line">        <span class="type">int</span> priority;</span><br><span class="line">        std::function&lt;<span class="type">void</span>()&gt; func;</span><br><span class="line"> </span><br><span class="line">        <span class="built_in">Task</span>(<span class="type">int</span> p, std::function&lt;<span class="built_in">void</span>()&gt; f) : <span class="built_in">priority</span>(p), <span class="built_in">func</span>(std::<span class="built_in">move</span>(f)) {}</span><br><span class="line"> </span><br><span class="line">        <span class="type">bool</span> <span class="keyword">operator</span>&lt;(<span class="type">const</span> Task&amp; other) <span class="type">const</span> {</span><br><span class="line">            <span class="keyword">return</span> priority &lt; other.priority;</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"> </span><br><span class="line">    std::vector&lt;std::thread&gt; mThreads;</span><br><span class="line">    std::condition_variable mEventVar;</span><br><span class="line">    std::mutex mEventMutex;</span><br><span class="line">    <span class="type">bool</span> mStopping = <span class="literal">false</span>;</span><br><span class="line">    std::priority_queue&lt;Task&gt; mTasks;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">(<span class="type">size_t</span> numThreads)</span> </span>{</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; numThreads; ++i) {</span><br><span class="line">            mThreads.<span class="built_in">emplace_back</span>([=] {</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">                    Task <span class="built_in">task</span>(<span class="number">0</span>, <span class="literal">nullptr</span>);</span><br><span class="line">                    {</span><br><span class="line">                        std::unique_lock&lt;std::mutex&gt; <span class="built_in">lock</span>(mEventMutex);</span><br><span class="line">                        mEventVar.<span class="built_in">wait</span>(lock, [=] { <span class="keyword">return</span> mStopping || !mTasks.<span class="built_in">empty</span>(); });</span><br><span class="line">                        <span class="keyword">if</span> (mStopping &amp;&amp; mTasks.<span class="built_in">empty</span>())</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        task = std::<span class="built_in">move</span>(mTasks.<span class="built_in">top</span>());</span><br><span class="line">                        mTasks.<span class="built_in">pop</span>();</span><br><span class="line">                    }</span><br><span class="line">                    task.<span class="built_in">func</span>();</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">stop</span><span class="params">()</span> </span>{</span><br><span class="line">        {</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mEventMutex)</span></span>;</span><br><span class="line">            mStopping = <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        mEventVar.<span class="built_in">notify_all</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;thread : mThreads)</span><br><span class="line">            thread.<span class="built_in">join</span>();</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">exampleTask</span><span class="params">(<span class="type">int</span> id)</span> </span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"Task "</span> &lt;&lt; id &lt;&lt; <span class="string">" executed by thread "</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function">PriorityThreadPool <span class="title">pool</span><span class="params">(<span class="number">4</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) {</span><br><span class="line">        pool.<span class="built_in">enqueue</span>([i] { <span class="built_in">exampleTask</span>(i); }, i % <span class="number">3</span>); <span class="comment">// Assign different priorities</span></span><br><span class="line">    }</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<hr>
<p><strong>å‚è€ƒæ–‡çŒ®ï¼š</strong></p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ACMer_L/article/details/107578636">C/C++æ‰‹æ’•çº¿ç¨‹æ± ï¼ˆçº¿ç¨‹æ± çš„å°è£…å’Œå®ç°ï¼‰</a></p></li>
<li><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/11609571649">æ·±å…¥è§£æC++çº¿ç¨‹æ± ï¼šåŸç†ã€å®ç°ã€åº”ç”¨ä¸çº¿ç¨‹æ± ä¼˜åŒ–</a></p></li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Tohomson/p/18803762">çº¿ç¨‹æ± çš„è®¾è®¡ä¸å®ç° C &amp;&amp; C++17</a></p></li>
</ul>
</div>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2025-11-17</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« Stocks yuan</span>
            
            
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/Cpp/'>
                            Cpp
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    
        
            
    
            <div class="post-footer-pre-next">
                

                
                    <span class="post-footer-pre-next-last-span-right">ä¸‹ä¸€ç¯‡ï¼š<a href="/2025/11/17/stl%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">STLå­¦ä¹ è®°å½•</a>
                    </span>
                
            </div>
    
        
    

    
        

     
</div>




                    

                    <div class="footer">
    
        <span> 
            Â© 2025 stocks-yuan 

            
                

            
        </span>
       
    
</div>



<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>ğŸŒŠçœ‹è¿‡å¤§æµ·çš„äººä¸ä¼šå¿˜è®°æµ·çš„å¹¿é˜”ğŸŒŠ</span>
            
                <span class="footer-last-span-right"><i>æœ¬ç«™ç”±<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>é©±åŠ¨ï½œä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>ä¸»é¢˜</i></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery/lightgallery.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-thumbnail.umd.min.js"></script>



<script src="/js/lightgallery/plugins/lg-fullscreen.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-autoplay.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-zoom.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-rotate.umd.min.js"></script>


<script src="/js/lightgallery/plugins/lg-paper.umd.min.js"></script>




<script type="text/javascript">
     
    if (typeof lightGallery !== "undefined") {
        var options1 = {
            selector: '.gallery-item',
            plugins: [lgThumbnail, lgFullscreen, lgAutoplay, lgZoom, lgRotate, lgPager], // å¯ç”¨æ’ä»¶
            thumbnail: true,          // æ˜¾ç¤ºç¼©ç•¥å›¾
            zoom: true,               // å¯ç”¨ç¼©æ”¾åŠŸ
            rotate: true,             // å¯ç”¨æ—‹è½¬åŠŸèƒ½èƒ½
            autoplay: true,        // å¯ç”¨è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
            fullScreen: true,      // å¯ç”¨å…¨å±åŠŸèƒ½
            pager: false, //é¡µç ,
            zoomFromOrigin: true,   // ä»åŸå§‹ä½ç½®ç¼©æ”¾
            actualSize: true,       // å¯ç”¨æŸ¥çœ‹å®é™…å¤§å°çš„åŠŸèƒ½
            enableZoomAfter: 300,    // å»¶è¿Ÿç¼©æ”¾ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå¯ç¼©æ”¾
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1); // ä¿®å¤é€‰æ‹©å™¨
    }
    
</script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> 

                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>
<script src="/js/emojiHandler.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        wrapEmojis('.paper');
    });
</script>
